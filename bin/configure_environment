#!/usr/bin/env bash

COURSE_IMAGE="lvlup/ci_course"
CURRENT_PATH="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
# shellcheck source=/dev/null
source "${CURRENT_PATH}/support/sh/functions/output.sh"

function check_installed() {
    local requirement=$1
    if ! which "${requirement}" > /dev/null; then
        error "${requirement} not installed"
    fi
}

function check_environment() {
    check_installed "docker"
    check_installed "ruby"
    check_installed "bundler"
}

say "$(ok "Checking that environment has the required software")"
missing_requirements=$(check_environment)
if [[ -z ${missing_requirements} ]]; then

    say "$(ok "Fetching Ruby gems")"
    if ! bundle --gemfile "${CURRENT_PATH}/../Gemfile"
    then
        say "$(error "Failed to download Ruby gems")"
        exit 1
    fi

    say "$(ok "Fetching course container from dockerhub")"
    if ! docker pull ${COURSE_IMAGE}
    then
        say "$(error "Failed to pull course image")"
        exit 1
    fi

    say "$(ok "environment setup complete :)")"
else
    say "${missing_requirements}"
fi

